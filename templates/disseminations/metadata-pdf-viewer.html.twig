<!-- Include PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

<style type="text/css">
    #pdf-viewer-container {
        display: flex;
        height: 600px; /* Set the desired height here */
    }

    #thumbnail-container {
        width: 150px;
        overflow-y: auto;
        border-right: 1px solid #ccc;
        height: 100%; /* Ensures it matches the height of the main container */
    }

    #pdf-container {
        flex: 1;
        overflow: auto;
        border: 1px solid #ccc;
        height: 100%; /* Ensures it matches the height of the main container */
    }

</style>

<div id="pdf-toolbar">

    <div class="container">
        <div class="row justify-content-center align-items-center g-4 my-3">
            <!-- Paging Controls Column -->
            <div class="col-lg-6">
                <button id="prev-page" class="btn btn-arche-blue-sidebar me-2">Previous</button>
                <span>Page: <span id="page-num">1</span> / <span id="page-count">--</span></span>
                <button id="next-page" class="btn btn-arche-blue-sidebar ms-2">Next</button>
            </div>
            <!-- Zoom Controls Column -->
            <div class="col-lg-6 text-end">
                <button id="zoom-out" class="btn btn-arche-blue-sidebar me-2">Zoom Out</button>
                <button id="zoom-in" class="btn btn-arche-blue-sidebar ms-2">Zoom In</button>
            </div>
        </div>
    </div>
</div>

<div id="pdf-viewer-container" >
    <div id="thumbnail-container"></div>
    <div id="pdf-container" ></div>
</div>



<script>
    $(document).ready(function () {
        const url = '{{  data.getRepoUrl()|raw  }}'; // Replace with your PDF file URL
        const pdfContainer = $('#pdf-container');
        const thumbnailContainer = $('#thumbnail-container');
        const toolbar = $('#pdf-toolbar');
        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1;
        let baseScale = 1;  // Initial fit-to-container scale
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // Load PDF document
        pdfjsLib.getDocument(url).promise.then(function (pdf) {
            pdfDoc = pdf;
            $('#page-count').text(pdf.numPages);
            renderPage(currentPage);
            renderThumbnails();
        }).catch((error) => {
            $('#pdf-viewer-container').addClass('d-none');
            $('#pdf-toolbar').addClass('d-none');
            console.log('Error loading PDF:', error);
        });
// Function to render a page in the main viewer
        function renderPage(pageNumber) {
            pdfDoc.getPage(pageNumber).then(function (page) {
                // Get the dimensions of the pdf-container
                const containerWidth = pdfContainer.width();
                const containerHeight = pdfContainer.height();

                // Calculate base scale only if it hasnâ€™t been set (for initial fit)
                if (baseScale === 1) {
                    const viewport = page.getViewport({scale: 1});
                    const scaleX = containerWidth / viewport.width;
                    const scaleY = containerHeight / viewport.height;
                    baseScale = Math.min(scaleX, scaleY); // Set the initial fit-to-container scale
                }

                // Calculate the actual scale by multiplying baseScale with zoom scale
                const viewport = page.getViewport({scale: baseScale * scale});

                // Create and resize the canvas to fit the container
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Clear and append the canvas to the container
                pdfContainer.empty().append(canvas);

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                page.render(renderContext);
                $('#page-num').text(pageNumber);
            });
        }

        // Function to render thumbnails
        function renderThumbnails() {
            thumbnailContainer.empty();
            for (let pageNumber = 1; pageNumber <= pdfDoc.numPages; pageNumber++) {
                pdfDoc.getPage(pageNumber).then(function (page) {
                    const viewport = page.getViewport({scale: 0.3}); // Smaller scale for thumbnails
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    page.render({
                        canvasContext: context,
                        viewport: viewport
                    });

                    // Set click handler to jump to page
                    $(canvas).css('margin-bottom', '10px').click(function () {
                        currentPage = pageNumber;
                        renderPage(currentPage);
                    });

                    thumbnailContainer.append(canvas);
                });
            }
        }

        // Toolbar controls
        $('#prev-page').click(function () {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        });

        $('#next-page').click(function () {
            if (currentPage < pdfDoc.numPages) {
                currentPage++;
                renderPage(currentPage);
            }
        });

        $('#zoom-in').click(function () {
            scale += 0.25;
            renderPage(currentPage);
        });

        $('#zoom-out').click(function () {
            if (scale > 0.5) {
                scale -= 0.25;
                renderPage(currentPage);
            }
        });

        // Enable dragging for zoomed content
        pdfContainer.on('mousedown', function (e) {
            isDragging = true;
            startX = e.pageX - pdfContainer.offset().left;
            startY = e.pageY - pdfContainer.offset().top;
            scrollLeft = pdfContainer.scrollLeft();
            scrollTop = pdfContainer.scrollTop();
        });

        $(document).on('mousemove', function (e) {
            if (isDragging) {
                e.preventDefault();
                const x = e.pageX - pdfContainer.offset().left;
                const y = e.pageY - pdfContainer.offset().top;
                const walkX = x - startX;
                const walkY = y - startY;
                pdfContainer.scrollLeft(scrollLeft - walkX);
                pdfContainer.scrollTop(scrollTop - walkY);
            }
        });

        $(document).on('mouseup', function () {
            isDragging = false;
        });

    });


</script>

